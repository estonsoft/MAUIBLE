// Warning: Some assembly references could not be resolved automatically. This might lead to incorrect decompilation of some parts,
// for ex. property getter/setter access. To get optimal decompilation results, please manually add the missing references to the list of loaded assemblies.
// MTUSDKNET, Version=1.1.9.0, Culture=neutral, PublicKeyToken=null
// MTUSDKNET.MMXVirtualDevice
using System;
using System.Threading.Tasks;



public class MMXVirtualDevice
{
	protected MMXConnectionState mState;

	private const string StartMSRTransactionRequest = "AAFF810401001001840A100181013C8203010000";

	private const string StartMSRTransactionResponse = "AAFF810482001001A206810100820101";

	private const string MSRNotification = "AAFF81048300100183050010010101";

	private const string MSRRequest = "AAFF81040100101084021010";

	private const string MSRResponse = "AAFF810482001010A2068101008201008482009F1010820400010000A4820093810400010100A4820089A04C81040100078084442542353535353535353535353535343434345E564953412F4155544F4D4154494F4E205E313930363130313036303836303030303030303030303637383030303030303FA02F81040200058084273B353535353535353535353535343434343D31393036313031303630383630303036373830303FA0088104030100808400";

	private const string StartEMVTransactionRequest = "AAFF810401001001840A100181013C8203070000";

	private const string ARQCNotification = "AAFF810483000803820410040501";

	private const string ARQCQuickChipNotification = "AAFF810483000805820410040501";

	private const string BatchNotification = "AAFF810483000805820410040301";

	private const string GetDataMSRRequest = "AAFF81040100101084051010810101";

	private const string GetDataARQCRequest = "AAFF81040100101084051010810102";

	private const string GetDataBatchRequest = "AAFF81040100101084051010810103";

	private const string ARQCResponse = "AAFF810482011010820400000000848202011010810102820401020000848201F201E9F98201E5DFDF540A00000000000000000000DFDF550182DFDF250F423444423831373131313931394141FA8201BB708201B7DFDF5301005F201247555354494E2F5354455048414E4945204D5F30020201DFDF4D253B353332323030303036303030313637343D3138303932303130303030303030303030303FDFDF520105F8820166DFDF59820148366998574C81086628B61FDD69B1C343F7BA98B25A92535FDA636DDA4495F1152D01079A4CEB280B305C21B239EDE7EEB61A7943562E261EC987861968FAEB4A2BBDF55D546FC46797FF422CD6CF36034858A4239B51035C320BDC5E4EE5951BB5C518E7330BD2FE8DE85C474D3C167942481DCD83D55864482317F329A7F1F175F4B9C645F302281C90C783B949AF56BD7673E7457D25C5773FC79A1BED520A055415B79A2A59C1676DE28C028B9764965D4CF831A22075128D99C1A2DFAB550A622479CFA8513DAE8491A580199FBC75B0F9565EBA57A3B161AA8443F0D8E644C1FA510E0AB0F7F261575B867EABDC490087A03B695FC145C4109AA85FB630592C25FA15A5448324963D5A03503602EC6B157C8DCC66BFB7F4CF4C6D677587B94ED4087625F8B8EFBFA8A072F981ABFF4984E7BC8FC5DDA086B274DD598AB2835DDDCC0C300196DFDF560A9010010B4DB817000003DFDF570180DFDF58010500000000000000";

	private const string BatchResponse = "AAFF8104820310108204000000008482017D10108101038204010400008482016E0164F9820160DFDF540A00000000000000000000DFDF550182DFDF250F423132333435363132313831384141FA820136F0820132F10ADFDF1A0100DFDF1B0100F881A5DFDF598188464DE8797843E290BE807237C24ED5472DAFA150CADE09AB597275008BB27D35CFF253F643DAAA955B8BD7A72FFF9374FBBB77E66D19117F05F9D05646655A74D493994CB1614EA172BB7DFA07B36FE3E162A5FB633EC5772598F49A9C7BC6B99793AAD4E9677FA3AE23FD34E0152C1464083A191D83C4423CD027B6C8B9743AB77350691E7E7245DFDF560A9010010B123456000022DFDF570180DFDF580103F77C5F2A0208409F02060000000009999F03060000000000009F0607A00000000410109F1C0831313232333334349F3901919C01009F34033F00005F5701005F201143415244484F4C4445522F4A4F484E2051DFDF4D273B313233343030303030303030363738393D31373132303030303030303030303030303030303F0000000000000000";

	public bool isOpen => mState == MMXConnectionState.Connected;

	public event EventHandler<byte[]> onMessage;

	public event EventHandler<MMXConnectionState> onConnectionStateChanged;

	public void initialize()
	{
	}

	public void setConnectionType(MMXConnectionType ConnectionType)
	{
	}

	public void open(string DeviceName = "")
	{
		try
		{
			MService_onConnectionChanged(this, MMXConnectionState.Connecting);
			MService_onConnectionChanged(this, MMXConnectionState.Connected);
		}
		catch (Exception)
		{
		}
	}

	private void MService_onConnectionChanged(object sender, MMXConnectionState e)
	{
		this.onConnectionStateChanged?.Invoke(this, e);
	}

	public void close()
	{
		try
		{
			MService_onConnectionChanged(this, MMXConnectionState.Disconnecting);
			MService_onConnectionChanged(this, MMXConnectionState.Disconnected);
		}
		catch (Exception)
		{
		}
	}

	public void sendMessage(MMXMessage message)
	{
		try
		{
			string hexString = TLVParser.getHexString(message.getData());
			if ("AAFF810401001001840A100181013C8203010000".CompareTo(hexString) == 0)
			{
				OnMessageReceived(this, TLVParser.getByteArrayFromHexString("AAFF810482001001A206810100820101"));
				OnMessageReceived(this, TLVParser.getByteArrayFromHexString("AAFF81048300100183050010010101"));
			}
			else if ("AAFF81040100101084021010".CompareTo(hexString) == 0)
			{
				OnMessageReceived(this, TLVParser.getByteArrayFromHexString("AAFF810482001010A2068101008201008482009F1010820400010000A4820093810400010100A4820089A04C81040100078084442542353535353535353535353535343434345E564953412F4155544F4D4154494F4E205E313930363130313036303836303030303030303030303637383030303030303FA02F81040200058084273B353535353535353535353535343434343D31393036313031303630383630303036373830303FA0088104030100808400"));
			}
			else if ("AAFF810401001001840A100181013C8203070000".CompareTo(hexString) == 0)
			{
				OnMessageReceived(this, TLVParser.getByteArrayFromHexString("AAFF810483000805820410040501"));
				OnMessageReceived(this, TLVParser.getByteArrayFromHexString("AAFF810483000805820410040301"));
			}
			else if ("AAFF81040100101084051010810101".CompareTo(hexString) == 0)
			{
				OnMessageReceived(this, TLVParser.getByteArrayFromHexString("AAFF810482001010A2068101008201008482009F1010820400010000A4820093810400010100A4820089A04C81040100078084442542353535353535353535353535343434345E564953412F4155544F4D4154494F4E205E313930363130313036303836303030303030303030303637383030303030303FA02F81040200058084273B353535353535353535353535343434343D31393036313031303630383630303036373830303FA0088104030100808400"));
			}
			else if ("AAFF81040100101084051010810102".CompareTo(hexString) == 0)
			{
				OnMessageReceived(this, TLVParser.getByteArrayFromHexString("AAFF810482011010820400000000848202011010810102820401020000848201F201E9F98201E5DFDF540A00000000000000000000DFDF550182DFDF250F423444423831373131313931394141FA8201BB708201B7DFDF5301005F201247555354494E2F5354455048414E4945204D5F30020201DFDF4D253B353332323030303036303030313637343D3138303932303130303030303030303030303FDFDF520105F8820166DFDF59820148366998574C81086628B61FDD69B1C343F7BA98B25A92535FDA636DDA4495F1152D01079A4CEB280B305C21B239EDE7EEB61A7943562E261EC987861968FAEB4A2BBDF55D546FC46797FF422CD6CF36034858A4239B51035C320BDC5E4EE5951BB5C518E7330BD2FE8DE85C474D3C167942481DCD83D55864482317F329A7F1F175F4B9C645F302281C90C783B949AF56BD7673E7457D25C5773FC79A1BED520A055415B79A2A59C1676DE28C028B9764965D4CF831A22075128D99C1A2DFAB550A622479CFA8513DAE8491A580199FBC75B0F9565EBA57A3B161AA8443F0D8E644C1FA510E0AB0F7F261575B867EABDC490087A03B695FC145C4109AA85FB630592C25FA15A5448324963D5A03503602EC6B157C8DCC66BFB7F4CF4C6D677587B94ED4087625F8B8EFBFA8A072F981ABFF4984E7BC8FC5DDA086B274DD598AB2835DDDCC0C300196DFDF560A9010010B4DB817000003DFDF570180DFDF58010500000000000000"));
			}
			else if ("AAFF81040100101084051010810103".CompareTo(hexString) == 0)
			{
				OnMessageReceived(this, TLVParser.getByteArrayFromHexString("AAFF8104820310108204000000008482017D10108101038204010400008482016E0164F9820160DFDF540A00000000000000000000DFDF550182DFDF250F423132333435363132313831384141FA820136F0820132F10ADFDF1A0100DFDF1B0100F881A5DFDF598188464DE8797843E290BE807237C24ED5472DAFA150CADE09AB597275008BB27D35CFF253F643DAAA955B8BD7A72FFF9374FBBB77E66D19117F05F9D05646655A74D493994CB1614EA172BB7DFA07B36FE3E162A5FB633EC5772598F49A9C7BC6B99793AAD4E9677FA3AE23FD34E0152C1464083A191D83C4423CD027B6C8B9743AB77350691E7E7245DFDF560A9010010B123456000022DFDF570180DFDF580103F77C5F2A0208409F02060000000009999F03060000000000009F0607A00000000410109F1C0831313232333334349F3901919C01009F34033F00005F5701005F201143415244484F4C4445522F4A4F484E2051DFDF4D273B313233343030303030303030363738393D31373132303030303030303030303030303030303F0000000000000000"));
			}
		}
		catch (Exception)
		{
		}
	}

	internal void OnMessageReceived(object sender, byte[] data)
	{
		this.onMessage?.Invoke(this, data);
	}

	public byte[] SendAndReceive(byte[] data, int TimeOut = 1000)
	{
		TaskCompletionSource<byte[]> completeBytes = new TaskCompletionSource<byte[]>();
		EventHandler<byte[]> value = delegate(object o, byte[] d)
		{
			completeBytes.TrySetResult(d);
		};
		onMessage += value;
		try
		{
			sendMessage(new MMXMessage(48, data));
			completeBytes.Task.Wait(TimeOut);
			if (completeBytes.Task.IsCompleted)
			{
				return completeBytes.Task.Result;
			}
		}
		finally
		{
			onMessage -= value;
		}
		return null;
	}
}
